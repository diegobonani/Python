{% extends 'base.html' %}
{% load static %}

{% block title %}Painel do Administrador{% endblock %}

{% block content %}
<div class="d-flex" style="min-height: 100vh;">
    
    <div class="flex-shrink-0 bg-dark" style="width: 280px;">
        {% include 'partials/sidebar_admin.html' %}
    </div>

    <div class="flex-grow-1 bg-light" style="overflow-y: auto; max-height: 100vh;">
        <div class="container-fluid p-4">
            
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="h3 mb-0 text-gray-800"><i class="fas fa-tachometer-alt me-2 text-primary"></i>Dashboard Geral</h2>
                    <span class="text-muted small">Visão geral e métricas do sistema.</span>
                </div>
                <div class="date-display text-muted bg-white px-3 py-2 rounded shadow-sm border">
                    <i class="far fa-calendar-alt me-2 text-primary"></i> {% now "d \d\e F \d\e Y" %}
                </div>
            </div>

            <div class="card shadow-sm mb-4 border-0">
                <div class="card-header bg-white border-bottom-0 pt-3">
                    <h6 class="m-0 font-weight-bold text-secondary"><i class="fas fa-filter me-1"></i> Filtros Globais</h6>
                </div>
                <div class="card-body">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-9">
                            <label for="filtro-dashboard" class="form-label small fw-bold text-muted">Filtrar por Usuário / Entidade:</label>
                            <select id="filtro-dashboard" class="form-select" multiple>
                                {% for opcao in filtro_opcoes %}
                                    <option value="{{ opcao.id }}">{{ opcao.text }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button id="btn-filtrar-dashboard" class="btn btn-primary w-100 fw-bold">
                                <i class="fas fa-sync-alt me-1"></i> Atualizar Dados
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4 mb-4">
                
                <div class="col-xl-3 col-md-6">
                    <div class="card h-100 border-0 shadow-sm border-start border-4 border-primary">
                        <div class="card-body">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <div class="text-uppercase fw-bold text-primary small">Usuários</div>
                                <div class="bg-primary bg-opacity-10 text-primary rounded-circle p-2">
                                    <i class="fas fa-users fa-lg"></i>
                                </div>
                            </div>
                            <div class="h3 mb-0 fw-bold text-gray-800" id="count-usuarios">
                                {{ total_usuarios|floatformat:0 }}
                            </div>
                        </div>
                        <div class="card-footer bg-white border-0 pt-0">
                            <a href="#" class="btn btn-sm btn-link text-decoration-none p-0 text-primary fw-bold" data-bs-toggle="modal" data-bs-target="#modalUsuarios">
                                Ver detalhes <i class="fas fa-arrow-right ms-1"></i>
                            </a>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6">
                    <div class="card h-100 border-0 shadow-sm border-start border-4 border-success">
                        <div class="card-body">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <div class="text-uppercase fw-bold text-success small">Itens em Estoque</div>
                                <div class="bg-success bg-opacity-10 text-success rounded-circle p-2">
                                    <i class="fas fa-box fa-lg"></i>
                                </div>
                            </div>
                            <div class="h3 mb-0 fw-bold text-gray-800" id="count-itens-estoque">
                                {{ total_itens_estoque|floatformat:0 }}
                            </div>
                        </div>
                        <div class="card-footer bg-white border-0 pt-0">
                            <a href="#" class="btn btn-sm btn-link text-decoration-none p-0 text-success fw-bold" data-bs-toggle="modal" data-bs-target="#modalEstoque">
                                Ver detalhes <i class="fas fa-arrow-right ms-1"></i>
                            </a>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6">
                    <div class="card h-100 border-0 shadow-sm border-start border-4 border-warning">
                        <div class="card-body">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <div class="text-uppercase fw-bold text-warning small">Saldo Financeiro</div>
                                <div class="bg-warning bg-opacity-10 text-warning rounded-circle p-2">
                                    <i class="fas fa-wallet fa-lg"></i>
                                </div>
                            </div>
                            <div class="h3 mb-0 fw-bold text-gray-800 text-truncate" id="count-lancamentos-financeiros">
                                R$ {{ saldo_financeiro }}
                            </div>
                        </div>
                        <div class="card-footer bg-white border-0 pt-0">
                            <a href="#" class="btn btn-sm btn-link text-decoration-none p-0 text-warning fw-bold" data-bs-toggle="modal" data-bs-target="#modalFinancas">
                                Ver detalhes <i class="fas fa-arrow-right ms-1"></i>
                            </a>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6">
                    <div class="card h-100 border-0 shadow-sm border-start border-4 border-danger">
                        <div class="card-body">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <div class="text-uppercase fw-bold text-danger small">Tarefas de Hoje</div>
                                <div class="bg-danger bg-opacity-10 text-danger rounded-circle p-2">
                                    <i class="fas fa-tasks fa-lg"></i>
                                </div>
                            </div>
                            <div class="h3 mb-0 fw-bold text-gray-800" id="count-tarefas-rotina">
                                {{ total_tarefas_rotina|floatformat:0 }}
                            </div>
                        </div>
                        <div class="card-footer bg-white border-0 pt-0">
                            <a href="#" class="btn btn-sm btn-link text-decoration-none p-0 text-danger fw-bold" data-bs-toggle="modal" data-bs-target="#modalRotinas">
                                Ver detalhes <i class="fas fa-arrow-right ms-1"></i>
                            </a>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6">
                    <div class="card h-100 border-0 shadow-sm border-start border-4 border-info">
                        <div class="card-body">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <div class="text-uppercase fw-bold text-info small">Nutrição (Média/Hoje)</div>
                                <div class="bg-info bg-opacity-10 text-info rounded-circle p-2">
                                    <i class="fas fa-utensils fa-lg"></i>
                                </div>
                            </div>
                            <div class="h3 mb-0 fw-bold text-gray-800" id="count-alimentacao">
                                {{ media_calorias_hoje|default:"0" }} <span class="small text-muted" style="font-size: 0.5em;">kcal</span>
                            </div>
                            <div class="progress mt-2" style="height: 5px;">
                                <div class="progress-bar bg-info" role="progressbar" style="width: 0%" id="progress-alimentacao"></div>
                            </div>
                            <small class="text-muted" id="status-meta-alimentacao" style="font-size: 0.75rem;">Aguardando seleção...</small>
                        </div>
                        <div class="card-footer bg-white border-0 pt-0">
                            <a href="#" class="btn btn-sm btn-link text-decoration-none p-0 text-info fw-bold" data-bs-toggle="modal" data-bs-target="#modalAlimentacao">
                                Ver Progresso <i class="fas fa-arrow-right ms-1"></i>
                            </a>
                        </div>
                    </div>
                </div>

            </div> </div>
    </div>
</div>

<div class="modal fade" id="modalUsuarios" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-users me-2"></i> Detalhes dos Usuários</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="corpoModalUsuarios"></div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEstoque" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-box me-2"></i> Detalhes do Estoque</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="corpoModalEstoque"></div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalFinancas" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="fas fa-wallet me-2"></i> Detalhes Financeiros</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="corpoModalFinancas"></div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalRotinas" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-tasks me-2"></i> Detalhes de Rotinas</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="corpoModalRotinas"></div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalAlimentacao" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-utensils me-2"></i> Metas Nutricionais</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="corpoModalAlimentacao">
                <div class="text-center py-5 text-muted">
                    <div class="spinner-border text-info" role="status"></div>
                    <p class="mt-2">Carregando dados nutricionais...</p>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalHistoricoNutri" tabindex="-1" aria-hidden="true" style="z-index: 1060;">
    <div class="modal-dialog modal-dialog-centered"> 
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-white border-bottom-0 pb-0">
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-0" id="corpoModalHistorico">
                </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Define as URLs geradas pelo Django em um objeto global
    window.DASHBOARD_URLS = {
        UPDATE_COUNTS: "{% url 'update_dashboard_counts' %}",
        PARTIAL_USUARIOS: "{% url 'tabela_usuarios_partial' %}",
        PARTIAL_ESTOQUE: "{% url 'tabela_estoque_partial' %}",
        PARTIAL_FINANCAS: "{% url 'tabela_financas_partial' %}",
        PARTIAL_ROTINAS: "{% url 'tabela_rotinas_partial' %}",
        PARTIAL_ALIMENTACAO: "{% url 'alimentacao:tabela_alimentacao_partial' %}",
        HISTORICO_USUARIO: "{% url 'alimentacao:historico_nutricional_partial' 0 %}"
    };
</script>

<script src="{% static 'js/dashboard_admin.js' %}?v=3"></script>
{% endblock %}