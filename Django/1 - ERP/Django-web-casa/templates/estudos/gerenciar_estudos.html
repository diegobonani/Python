{% extends 'base.html' %}
{% load static %}

{% block title %}Hub de Estudos{% endblock %}

{% block styles %}
<style>
    /* --- ESTILOS VISUAIS GERAIS --- */
    .input-nota { 
        border: 1px solid #e3e6f0; background-color: #f8f9fc; 
        text-align: center; font-weight: bold; color: #5a5c69; 
        border-radius: 8px; transition: all 0.2s; 
    }
    .input-nota:focus { 
        border-color: #4e73df; background-color: #fff; 
        box-shadow: 0 0 0 3px rgba(78,115,223,0.1); outline: none; 
    }
    .card-disciplina { 
        border-left: 5px solid transparent; transition: transform 0.2s; 
        height: 100%; background: #fff; border-radius: 12px; 
    }
    .card-disciplina:hover { 
        transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.08)!important; 
    }
    .card-disciplina[data-status="normal"] { border-left-color: #4e73df; }
    .card-disciplina[data-status="atencao"] { border-left-color: #e74a3b; background-color: #fff5f5; }

    /* --- NOVO DESIGN: CURSOS & SKILLS --- */
    
    .hero-section {
        background: linear-gradient(135deg, #1a1c29 0%, #2c3e50 100%);
        border-radius: 24px;
        position: relative;
        overflow: hidden;
        color: white;
        box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        margin-bottom: 3rem;
    }
    
    .hero-bg-pattern {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background-image: radial-gradient(circle at 10% 20%, rgba(255,255,255,0.05) 0%, transparent 20%),
                          radial-gradient(circle at 90% 80%, rgba(255,255,255,0.05) 0%, transparent 20%);
        z-index: 1;
    }

    .hero-content {
        position: relative;
        z-index: 2;
        padding: 3rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .hero-glass-panel {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 16px;
        padding: 1.5rem 2rem;
        display: flex;
        align-items: center;
        gap: 1.5rem;
    }

    .btn-play-hero {
        background: #00ce79; /* Verde Vibrante */
        color: #0f172a;
        border: none;
        width: 60px; height: 60px;
        border-radius: 50%;
        font-size: 1.5rem;
        display: flex; align-items: center; justify-content: center;
        transition: transform 0.2s, box-shadow 0.2s;
        box-shadow: 0 0 20px rgba(0, 206, 121, 0.4);
    }
    .btn-play-hero:hover {
        transform: scale(1.1);
        box-shadow: 0 0 30px rgba(0, 206, 121, 0.6);
        color: #000;
    }

    /* CARDS DE CURSO */
    .netflix-card {
        border: none;
        background: white;
        border-radius: 12px;
        overflow: hidden;
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.3s;
        height: 100%;
        position: relative;
    }
    .netflix-card:hover {
        transform: translateY(-10px) scale(1.02);
        box-shadow: 0 20px 40px rgba(0,0,0,0.15) !important;
        z-index: 10;
    }
    
    .netflix-cover {
        height: 140px;
        background: linear-gradient(45deg, #4e73df 0%, #224abe 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }
    .netflix-cover i {
        font-size: 3.5rem;
        color: rgba(255,255,255,0.8);
        filter: drop-shadow(0 5px 15px rgba(0,0,0,0.2));
    }
    .netflix-badge {
        position: absolute;
        top: 10px; right: 10px;
        background: rgba(0,0,0,0.6);
        color: white;
        font-size: 0.7rem;
        padding: 4px 10px;
        border-radius: 20px;
        backdrop-filter: blur(4px);
    }

    .netflix-body {
        padding: 1.25rem;
        display: flex;
        flex-direction: column;
        height: calc(100% - 140px);
    }

    .netflix-progress-container {
        height: 4px;
        background: #e9ecef;
        border-radius: 2px;
        margin-top: 10px;
        overflow: hidden;
    }
    .netflix-progress-bar {
        height: 100%;
        background: #00ce79;
        border-radius: 2px;
    }

    .btn-assistir-sm {
        background-color: #f1f3f9;
        color: #4e73df;
        border: none;
        font-weight: 700;
        border-radius: 8px;
        padding: 8px 0;
        width: 100%;
        transition: all 0.2s;
    }
    .btn-assistir-sm:hover {
        background-color: #4e73df;
        color: white;
    }

    .add-course-card {
        border: 2px dashed #d1d3e2;
        background: transparent;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        min-height: 250px;
        color: #858796;
        transition: all 0.2s;
        cursor: pointer;
    }
    .add-course-card:hover {
        border-color: #4e73df;
        color: #4e73df;
        background: rgba(78, 115, 223, 0.05);
    }

    /* --- UTILIT√ÅRIOS --- */
    #loading-overlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); z-index: 100; justify-content: center; align-items: center; backdrop-filter: blur(4px); border-radius: 0.35rem; }
    .custom-check-item { display: flex; align-items: center; padding: 10px; border-radius: 8px; cursor: pointer; transition: background 0.2s; }
    .custom-check-item:hover { background-color: #f8f9fc; }
    .d-none-filter { display: none !important; }

    /* --- ESTILOS DO SIDEBAR PLAYER --- */
    .lesson-item:hover {
        background-color: rgba(255,255,255,0.05) !important;
        cursor: pointer;
    }
    .active-lesson {
        background-color: #4e73df !important; /* Azul */
        color: white !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex" style="min-height: 100vh;">
    
    <div class="flex-shrink-0 bg-dark" style="width: 280px;">
        {% include 'partials/sidebar_admin.html' %}
    </div>

    <div class="flex-grow-1 bg-light position-relative" style="overflow-y: auto; max-height: 100vh;">
        <div class="container-fluid p-4">

            <div class="d-flex justify-content-between align-items-center mb-5 flex-wrap gap-3">
                <div>
                    <h2 class="h3 mb-1 fw-bold text-gray-800" id="page-title">
                        <i class="fas fa-graduation-cap me-2 text-primary"></i>Gest√£o Escolar
                    </h2>
                    <span class="badge bg-white text-secondary border shadow-sm rounded-pill px-3 py-2" id="contador-alunos">
                        <i class="fas fa-user-check me-1"></i> {{ ids_selecionados|length }} pessoa(s)
                    </span>
                </div>

                <div class="bg-white p-1 rounded-pill border shadow-sm d-inline-flex">
                    <button class="btn btn-primary rounded-pill fw-bold px-4 py-2 mode-switch-btn shadow-sm" data-mode="escola" onclick="switchMode('escola')"><i class="fas fa-school me-2"></i>Escola (SED)</button>
                    <button class="btn btn-light text-muted rounded-pill fw-bold px-4 py-2 mode-switch-btn" data-mode="cursos" onclick="switchMode('cursos')"><i class="fas fa-laptop-code me-2"></i>Cursos & Skills</button>
                </div>

                <div class="d-flex align-items-center gap-2">
                    <div class="bg-white px-3 py-2 rounded-pill border shadow-sm text-muted fw-bold small d-flex align-items-center" style="height: 42px;">
                        <i class="far fa-calendar-alt me-2 text-primary"></i><span>{% now "d/m/Y" %}</span>
                    </div>

                    <div class="dropdown">
                        <button class="btn btn-white border fw-bold text-secondary rounded-pill px-4 py-2 shadow-sm" type="button" data-bs-toggle="dropdown" style="height: 42px;">
                            <i class="fas fa-filter me-2"></i>Filtrar
                        </button>
                        <div class="dropdown-menu dropdown-menu-end p-3 shadow-lg border-0" style="min-width: 300px; border-radius: 15px;">
                            <form id="formFiltroAjax">
                                <h6 class="dropdown-header fw-bold text-uppercase small text-primary mb-2">Quem exibir?</h6>
                                {% for pessoa in filhos %}
                                <label class="custom-check-item filter-item" 
                                       data-student="{{ pessoa.esta_estudando|yesno:'true,false' }}"
                                       data-course="{{ pessoa.esta_fazendo_curso|yesno:'true,false' }}">
                                    
                                    <input type="checkbox" class="form-check-input me-3 filtro-checkbox" name="filhos" value="{{ pessoa.id }}" {% if pessoa.id|stringformat:"i" in ids_selecionados %}checked{% endif %} style="transform: scale(1.2);">
                                    <div class="d-flex align-items-center w-100 justify-content-between">
                                        <span class="fw-bold text-dark">{{ pessoa.nome_completo }}</span>
                                        <div class="d-flex gap-1">
                                            {% if pessoa.esta_estudando %}<span class="badge bg-primary text-white border" title="Escola">E</span>{% endif %}
                                            {% if pessoa.esta_fazendo_curso %}<span class="badge bg-success text-white border" title="Cursos">C</span>{% endif %}
                                        </div>
                                    </div>
                                </label>
                                {% endfor %}
                            </form>
                        </div>
                    </div>
                    
                    <button class="btn btn-success rounded-circle shadow-lg btn-lg ms-2" data-bs-toggle="modal" data-bs-target="#modalNovoCadastro" title="Novo" style="width: 42px; height: 42px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-plus"></i></button>
                </div>
            </div>

            <div class="position-relative">
                <div id="loading-overlay"><div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div></div>
                <div id="conteudo-dinamico">

                    <div id="view-escola" class="animate__animated animate__fadeIn">
                        <div class="d-flex justify-content-between align-items-center mb-4 bg-white p-3 rounded-pill shadow-sm border">
                            <div class="btn-group">
                                {% for ano in anos_disponiveis %}
                                <a href="?ano={{ ano }}" class="btn btn-sm rounded-pill fw-bold {% if ano == ano_selecionado %}btn-primary px-4{% else %}btn-white text-muted{% endif %}" style="transition:all 0.2s;">{{ ano }}</a>
                                {% endfor %}
                            </div>
                            {% if not status.em_ferias %}
                                <div class="d-flex align-items-center text-muted fw-bold small"><i class="fas fa-clock me-2 text-warning"></i> Bimestre {{ status.trimestre_atual }}</div>
                            {% endif %}
                            <button class="btn btn-link text-decoration-none fw-bold small" data-bs-toggle="modal" data-bs-target="#modalRoboSed"><i class="fas fa-robot me-1"></i> Rob√¥ SED</button>
                        </div>

                        <div class="card shadow-sm mb-4 border-0 rounded-lg">
                            <div class="card-header py-0 bg-white border-bottom-0 pt-4 px-4">
                                <ul class="nav nav-tabs card-header-tabs border-bottom-0 gap-2">
                                    <li class="nav-item"><button class="nav-link active fw-bold text-primary px-3 py-2 border-0 bg-light rounded-top" data-bs-toggle="tab" data-bs-target="#tab_agenda"><i class="fas fa-calendar-check me-2"></i>Agenda</button></li>
                                    <li class="nav-item"><button class="nav-link fw-bold text-secondary px-3 py-2 border-0" data-bs-toggle="tab" data-bs-target="#tab_materias"><i class="fas fa-book me-2"></i>Mat√©rias</button></li>
                                    <li class="nav-item"><button class="nav-link fw-bold text-secondary px-3 py-2 border-0" data-bs-toggle="tab" data-bs-target="#tab_boletim"><i class="fas fa-star me-2"></i>Boletim</button></li>
                                    <li class="nav-item"><button class="nav-link fw-bold text-secondary px-3 py-2 border-0" data-bs-toggle="tab" data-bs-target="#tab_dificuldades"><i class="fas fa-brain me-2"></i>Aten√ß√£o</button></li>
                                </ul>
                            </div>
                            <div class="card-body bg-light p-4">
                                <div class="tab-content">
                                    <div class="tab-pane fade show active" id="tab_agenda">
                                        <div class="bg-white border rounded shadow-sm table-responsive">
                                            <table class="table table-hover align-middle mb-0">
                                                <thead class="bg-light text-uppercase text-muted small"><tr><th class="ps-4">Data</th><th>Aluno</th><th>Mat√©ria</th><th>Tarefa</th><th>Status</th></tr></thead>
                                                <tbody>
                                                    {% for atv in atividades %}
                                                        {% if atv.disciplina.categoria == 'ESCOLA' and atv.disciplina.usuario.perfil.esta_estudando %}
                                                        <tr>
                                                            <td class="ps-4 fw-bold">{{ atv.data_agendada|date:"d/m" }}</td>
                                                            <td>{{ atv.disciplina.usuario.first_name }}</td>
                                                            <td class="text-primary fw-bold">{{ atv.disciplina.nome }}</td>
                                                            <td>{{ atv.titulo }}</td>
                                                            <td><span class="badge {% if atv.concluido %}bg-success{% else %}bg-warning text-dark{% endif %} rounded-pill">{% if atv.concluido %}Feito{% else %}Pendente{% endif %}</span></td>
                                                        </tr>
                                                        {% endif %}
                                                    {% empty %}
                                                    <tr><td colspan="5" class="text-center py-5 text-muted opacity-50"><h5><i class="fas fa-check-circle me-2"></i>Nada pendente!</h5></td></tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="tab_materias">
                                        {% for dados in dados_por_aluno %}
                                            {% if dados.aluno.esta_estudando and dados.tem_dados_escola %}
                                                <h6 class="fw-bold mt-2 mb-3 ps-2 text-primary border-start border-4 border-primary ps-2">{{ dados.aluno.nome_completo }}</h6>
                                                <div class="row g-3 mb-4">
                                                    {% for item in dados.boletim_escola %}
                                                    <div class="col-xl-3 col-md-4 col-sm-6">
                                                        <div class="p-3 shadow-sm card-disciplina h-100" data-status="{% if item.diario.dificuldade_leitura %}atencao{% else %}normal{% endif %}">
                                                            <div class="d-flex justify-content-between align-items-start mb-2"><h6 class="fw-bold m-0 text-dark">{{ item.disciplina.nome }}</h6></div>
                                                            <ul class="list-unstyled small mb-0 text-muted">{% for topico in item.topicos|slice:":2" %}<li><i class="fas fa-check text-success me-1"></i> {{ topico.nome }}</li>{% empty %}<li class="fst-italic opacity-50">Sem t√≥picos.</li>{% endfor %}</ul>
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                    <div class="tab-pane fade" id="tab_boletim">
                                        <form method="post" action="{% url 'estudos:salvar_notas' %}"> {% csrf_token %}
                                            {% for dados in dados_por_aluno %}
                                                {% if dados.aluno.esta_estudando and dados.tem_dados_escola %}
                                                <div class="bg-white border rounded shadow-sm p-4 mb-4">
                                                    <div class="d-flex justify-content-between mb-3 align-items-center"><h6 class="fw-bold text-dark m-0">{{ dados.aluno.nome_completo }}</h6><span class="badge bg-light text-muted border rounded-pill">RA: {{ dados.aluno.ra_numero }}</span></div>
                                                    <div class="table-responsive"><table class="table table-sm table-bordered align-middle mb-0 text-center"><thead class="bg-light small text-muted"><tr><th class="text-start ps-3 py-2">Disciplina</th><th width="10%">1¬∫B</th><th width="10%">2¬∫B</th><th width="10%">3¬∫B</th><th width="10%">4¬∫B</th><th width="10%">Faltas</th></tr></thead><tbody>{% for item in dados.boletim_escola %}<tr><td class="text-start ps-3 fw-bold">{{ item.disciplina.nome }}</td><td><input type="number" step="0.1" name="n1_{{ item.diario.id }}" value="{{ item.diario.nota_1_bim|default:'' }}" class="form-control form-control-sm border-0 text-center input-nota p-1"></td><td><input type="number" step="0.1" name="n2_{{ item.diario.id }}" value="{{ item.diario.nota_2_bim|default:'' }}" class="form-control form-control-sm border-0 text-center input-nota p-1"></td><td><input type="number" step="0.1" name="n3_{{ item.diario.id }}" value="{{ item.diario.nota_3_bim|default:'' }}" class="form-control form-control-sm border-0 text-center input-nota p-1"></td><td><input type="number" step="0.1" name="n4_{{ item.diario.id }}" value="{{ item.diario.nota_4_bim|default:'' }}" class="form-control form-control-sm border-0 text-center input-nota p-1"></td><td class="bg-light"><input type="number" name="f_{{ item.diario.id }}" value="{{ item.diario.total_faltas }}" class="form-control form-control-sm border-0 text-center text-danger fw-bold p-1 bg-transparent"></td></tr>{% endfor %}</tbody></table></div>
                                                </div>
                                                {% endif %}
                                            {% endfor %}
                                            <div class="text-end"><button type="submit" class="btn btn-primary fw-bold px-5 py-2 shadow rounded-pill"><i class="fas fa-save me-2"></i> Salvar Altera√ß√µes</button></div>
                                        </form>
                                    </div>
                                    <div class="tab-pane fade" id="tab_dificuldades">
                                        <div class="bg-white border rounded shadow-sm table-responsive">
                                            <table class="table table-hover align-middle mb-0"><thead class="bg-light text-uppercase small text-muted"><tr><th class="ps-4">Aluno</th><th>Mat√©ria</th><th>Pontos de Aten√ß√£o</th></tr></thead><tbody>{% for diario in dificuldades %}<tr><td class="ps-4 fw-bold">{{ diario.matricula.aluno.nome_completo }}</td><td>{{ diario.disciplina_base.nome }}</td><td>{% if diario.dificuldade_leitura %}<span class="badge bg-danger me-1">Leitura</span>{% endif %}{% if diario.dificuldade_escrita %}<span class="badge bg-warning text-dark me-1">Escrita</span>{% endif %}{% if diario.dificuldade_logica %}<span class="badge bg-info text-dark">L√≥gica</span>{% endif %}</td></tr>{% empty %}<tr><td colspan="3" class="text-center py-5 text-muted">Nenhuma dificuldade cr√≠tica registrada.</td></tr>{% endfor %}</tbody></table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="view-cursos" class="animate__animated animate__fadeIn d-none">
                        
                        <div class="hero-section">
                            <div class="hero-bg-pattern"></div>
                            <div class="hero-content row">
                                <div class="col-md-7">
                                    <div class="d-flex align-items-center mb-3">
                                        <span class="badge bg-danger text-white me-2 px-3 py-2 rounded-pill shadow-sm">AO VIVO</span>
                                        <h5 class="m-0 text-white opacity-75">Ambiente de Aprendizado Coletivo</h5>
                                    </div>
                                    <h1 class="display-5 fw-bold mb-3">Sess√£o em Fam√≠lia</h1>
                                    <p class="lead opacity-75 mb-4" style="max-width: 90%;">Re√∫na a fam√≠lia, conecte na TV e aprendam juntos. O progresso √© registrado para todos os participantes automaticamente.</p>
                                    
                                    <div class="d-flex gap-3">
                                        <button class="btn btn-light rounded-pill px-4 py-3 fw-bold text-dark d-flex align-items-center gap-2 hover-scale" data-bs-toggle="modal" data-bs-target="#modalEstudoGrupo">
                                            <i class="fas fa-play"></i> INICIAR AGORA
                                        </button>
                                        <button class="btn btn-outline-light rounded-pill px-4 py-3 fw-bold" onclick="document.querySelector('.custom-check-item').scrollIntoView()">
                                            <i class="fas fa-info-circle me-2"></i> Como funciona?
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-5 d-none d-md-flex justify-content-end align-items-center">
                                    <div class="hero-glass-panel">
                                        <div class="text-end">
                                            <h6 class="m-0 text-white-50 small text-uppercase">√öltima Sess√£o</h6>
                                            <h4 class="fw-bold m-0">Ingl√™s B√°sico</h4>
                                        </div>
                                        <button class="btn-play-hero" data-bs-toggle="modal" data-bs-target="#modalEstudoGrupo">
                                            <i class="fas fa-play ms-1"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {% for dados in dados_por_aluno %}
                        {% if dados.aluno.esta_fazendo_curso %}
                            <div class="mb-5">
                                <div class="d-flex align-items-center mb-4 border-bottom pb-2">
                                    <div class="rounded-circle bg-gradient text-white d-flex align-items-center justify-content-center me-3 shadow bg-dark" style="width: 45px; height: 45px; font-size: 1.2rem;">
                                        {{ dados.aluno.nome_completo|slice:":1" }}
                                    </div>
                                    <h4 class="fw-bold text-gray-800 m-0">Cursos de {{ dados.aluno.nome_completo }}</h4>
                                </div>

                                {% if dados.cursos_extras %}
                                    <div class="row row-cols-1 row-cols-md-2 row-cols-xl-4 g-4">
                                        {% for curso in dados.cursos_extras %}
                                        <div class="col">
                                            <div class="netflix-card shadow-sm position-relative">
                                                
                                                <div class="dropdown position-absolute top-0 end-0 m-2" style="z-index: 20;">
                                                    <button class="btn btn-sm btn-dark bg-opacity-50 rounded-circle border-0" type="button" data-bs-toggle="dropdown" aria-expanded="false" style="width: 32px; height: 32px;">
                                                        <i class="fas fa-ellipsis-v text-white"></i>
                                                    </button>
                                                    <ul class="dropdown-menu dropdown-menu-end shadow">
                                                        <li>
                                                            <a class="dropdown-item fw-bold small" href="#" onclick="abrirModalEditar('{{ curso.id }}', '{{ curso.nome }}', '{{ curso.categoria }}')">
                                                                <i class="fas fa-pen text-primary me-2"></i>Editar
                                                            </a>
                                                        </li>
                                                        <li><hr class="dropdown-divider"></li>
                                                        <li>
                                                            <a class="dropdown-item fw-bold small text-danger" href="#" onclick="abrirModalExcluir('{{ curso.id }}', '{{ curso.nome }}')">
                                                                <i class="fas fa-trash-alt me-2"></i>Excluir
                                                            </a>
                                                        </li>
                                                    </ul>
                                                </div>

                                                <div class="netflix-cover">
                                                    <span class="netflix-badge">{{ curso.categoria }}</span>
                                                    <i class="fas fa-laptop-code"></i>
                                                </div>
                                                <div class="netflix-body">
                                                    <h6 class="fw-bold text-dark mb-2 text-truncate" title="{{ curso.nome }}">{{ curso.nome }}</h6>
                                                    
                                                    <div class="d-flex justify-content-between small text-muted mt-auto">
                                                        <span>Progresso</span>
                                                        <span class="fw-bold text-success">{{ curso.aulas_concluidas|default:0 }} / {{ curso.total_aulas_real|default:0 }} aulas</span>
                                                    </div>
                                                    <div class="netflix-progress-container mb-3">
                                                        <div class="netflix-progress-bar dynamic-bar" role="progressbar" 
                                                             aria-valuenow="{{ curso.porcentagem|default:0 }}" 
                                                             aria-valuemin="0" aria-valuemax="100"></div>
                                                    </div>
                                                    
                                                    <div class="d-flex gap-2">
                                                        <button type="button" 
                                                                class="btn-assistir-sm text-decoration-none text-center flex-grow-1 border-0"
                                                                onclick="abrirModalPlayer('{{ curso.id_proxima_aula }}', '{{ dados.aluno.id }}')"
                                                                {% if not curso.id_proxima_aula and curso.curso_catalogo %}disabled{% endif %}>
                                                            <i class="fas fa-play me-1"></i> {% if curso.id_proxima_aula %}ASSISTIR{% elif not curso.curso_catalogo %}ABRIR{% else %}SEM AULAS{% endif %}
                                                        </button>

                                                        <button type="button" class="btn btn-light border fw-bold text-secondary" 
                                                                data-bs-toggle="modal" 
                                                                data-bs-target="#modalAvaliacao" 
                                                                onclick="prepararAvaliacao('{{ curso.nome }}')"
                                                                title="Lan√ßar Nota / Prova">
                                                            <i class="fas fa-star text-warning"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                        
                                        <div class="col">
                                            <div class="add-course-card" onclick="abrirModalCurso('{{ dados.aluno.id }}')">
                                                <div class="mb-3 text-primary opacity-50"><i class="fas fa-plus-circle fa-3x"></i></div>
                                                <h6 class="fw-bold text-primary m-0">Explorar Cursos</h6>
                                            </div>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="text-center py-5 bg-white rounded-3 shadow-sm border border-light">
                                        <div class="mb-3 text-muted opacity-25"><i class="fas fa-film fa-3x"></i></div>
                                        <h6 class="text-muted fw-bold">A lista est√° vazia.</h6>
                                        <p class="small text-muted mb-3">Comece uma nova jornada de aprendizado agora.</p>
                                        <button class="btn btn-outline-primary rounded-pill btn-sm fw-bold px-4" onclick="abrirModalCurso('{{ dados.aluno.id }}')">
                                            <i class="fas fa-plus me-1"></i> Adicionar Curso
                                        </button>
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                        {% endfor %}
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalPlayer" data-bs-backdrop="static" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen"> <div class="modal-content bg-black">
            
            <div class="modal-header border-bottom border-secondary py-2 bg-dark text-white">
                <div class="d-flex align-items-center gap-3">
                    <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal" onclick="pararVideo()">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                    <div>
                        <h6 class="modal-title fw-bold mb-0" id="playerTitulo">Carregando...</h6>
                        <small class="text-muted" id="playerModulo">...</small>
                    </div>
                </div>
            </div>

            <div class="modal-body p-0 d-flex flex-column flex-lg-row h-100" style="overflow: hidden;">
                
                <div class="flex-grow-1 bg-black d-flex flex-column justify-content-center position-relative" style="min-height: 50vh;">
                    
                    <div class="w-100 h-100 d-flex align-items-center justify-content-center bg-black">
                        <video id="videoTag" controls style="max-width: 100%; max-height: 100%; width: 100%; height: auto; display: none;" controlsList="nodownload">
                            Seu navegador n√£o suporta v√≠deos.
                        </video>
                        <iframe id="videoFrame" src="" style="width: 100%; height: 100%; border:0; display: none;" allowfullscreen></iframe>
                    </div>

                    <div class="p-3 bg-dark border-top border-secondary d-flex justify-content-between align-items-center">
                        <button class="btn btn-outline-light btn-sm" id="btnAnterior" onclick="navegarAula('prev')" disabled>
                            <i class="fas fa-step-backward me-2"></i> Anterior
                        </button>

                        <button class="btn btn-success fw-bold px-4 shadow" id="btnProxima" onclick="navegarAula('next')">
                            Concluir e Pr√≥xima <i class="fas fa-step-forward ms-2"></i>
                        </button>
                    </div>
                </div>

                <div class="bg-dark border-start border-secondary d-flex flex-column" style="width: 350px; min-width: 350px;">
                    <div class="p-3 border-bottom border-secondary bg-secondary bg-opacity-10 text-white">
                        <h6 class="m-0 fw-bold"><i class="fas fa-list-ul me-2"></i> Conte√∫do do Curso</h6>
                    </div>
                    
                    <div class="flex-grow-1 overflow-auto" id="playlistContainer" style="scrollbar-width: thin;">
                        <div class="text-center py-5 text-muted">
                            <div class="spinner-border spinner-border-sm mb-2"></div><br>Carregando aulas...
                        </div>
                    </div>
                </div>

            </div>
            
            <input type="hidden" id="playerAlunoId">
            <input type="hidden" id="playerAulaId">
            <input type="hidden" id="playerNextId">
            <input type="hidden" id="playerPrevId">

        </div>
    </div>
</div>

<div class="modal fade" id="modalEstudoGrupo" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 shadow"><div class="modal-header bg-success text-white"><h5 class="modal-title fw-bold">Quem vai estudar agora?</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><form action="{% url 'estudos:registrar_estudo_grupo' %}" method="POST"> {% csrf_token %}<div class="modal-body p-4"><label class="fw-bold small text-muted text-uppercase mb-3">Participantes</label><div class="row g-2 mb-4">{% for f in filhos %}{% if f.esta_fazendo_curso %}<div class="col-6"><label class="card p-2 cursor-pointer h-100 border-2 custom-check-item"><div class="d-flex align-items-center"><input type="checkbox" name="participantes" value="{{ f.id }}" class="form-check-input me-2"><span class="fw-bold text-dark">{{ f.nome_completo|slice:":15" }}</span></div></label></div>{% endif %}{% endfor %}</div><div class="mb-3"><label class="fw-bold">Mat√©ria</label><input type="text" name="materia_nome" class="form-control" required list="sugestoes_materias"> <datalist id="sugestoes_materias"><option value="Ingl√™s"><option value="Programa√ß√£o"><option value="Finan√ßas"></datalist></div><div class="mb-3"><label class="fw-bold">Conte√∫do</label><input type="text" name="conteudo" class="form-control" required></div></div><div class="modal-footer"><button type="submit" class="btn btn-success w-100 rounded-pill fw-bold">Registrar</button></div></form></div></div></div>
<div class="modal fade" id="modalNovoCadastro" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title">Novo Cadastro</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body d-grid gap-2"><button class="btn btn-outline-primary fw-bold text-start p-3" data-bs-target="#modalDisciplina" data-bs-toggle="modal"><i class="fas fa-book me-2"></i> Disciplina / Curso</button><button class="btn btn-outline-success fw-bold text-start p-3" data-bs-target="#modalAtividade" data-bs-toggle="modal"><i class="fas fa-calendar-check me-2"></i> Tarefa / Prova</button><button class="btn btn-outline-info fw-bold text-start p-3" data-bs-target="#modalAvaliacao" data-bs-toggle="modal"><i class="fas fa-star me-2"></i> Nota Avulsa</button></div></div></div></div>
<div class="modal fade" id="modalDisciplina" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><form action="{% url 'estudos:adicionar_disciplina' %}" method="POST"> {% csrf_token %}<div class="modal-header"><h5 class="modal-title">Novo Curso / Disciplina</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="mb-3"><label class="fw-bold">Estudante</label><select name="aluno_id" id="selectAlunoDisciplina" class="form-select" required><option value="" disabled selected>Selecione...</option>{% for f in filhos %}<option value="{{ f.id }}">{{ f.nome_completo }}</option>{% endfor %}</select></div><div class="mb-3"><label class="fw-bold">Tipo</label><select name="categoria" class="form-select"><option value="EXTRA" selected>üéì Curso Livre (Netflix)</option><option value="ESCOLA">üè´ Escola (SED)</option></select></div><div class="mb-3"><label class="fw-bold">Nome</label>{{ form_disciplina.nome }}</div></div><div class="modal-footer"><button type="submit" class="btn btn-primary">Salvar</button></div></form></div></div></div>
<div class="modal fade" id="modalRoboSed" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title">Rob√¥ SED</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body text-center py-4"><p class="mb-0">Para sincronizar notas, execute no terminal:</p><code class="d-block mt-2 p-2 bg-light rounded">python manage.py puxar_notas_sed</code></div></div></div></div>
<div class="modal fade" id="modalAtividade" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Agendar Tarefa</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><form action="{% url 'estudos:adicionar_atividade' %}" method="POST">{% csrf_token %}<div class="modal-body">{{ form_atividade.as_p }}<button class="btn btn-success w-100 mt-3">Salvar</button></div></form></div></div></div>

<div class="modal fade" id="modalAvaliacao" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning bg-gradient text-dark">
                <h5 class="modal-title fw-bold"><i class="fas fa-star me-2"></i>Central de Avalia√ß√µes</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <ul class="nav nav-pills mb-4 gap-2" id="pills-tab" role="tablist">
                    <li class="nav-item" role="presentation"><button class="nav-link active fw-bold border" id="pills-nota-tab" data-bs-toggle="pill" data-bs-target="#pills-nota" type="button"><i class="fas fa-check-circle me-2"></i>Lan√ßar Nota</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link fw-bold border" id="pills-prova-tab" data-bs-toggle="pill" data-bs-target="#pills-prova" type="button"><i class="fas fa-print me-2"></i>Criar Prova Escrita</button></li>
                </ul>
                <div class="tab-content" id="pills-tabContent">
                    <div class="tab-pane fade show active" id="pills-nota" role="tabpanel">
                        <div class="alert alert-info small"><i class="fas fa-info-circle me-1"></i> Se a nota for <strong>azul (> 7.0)</strong>, o aluno ganha pontos automaticamente!</div>
                        <form action="{% url 'estudos:adicionar_avaliacao' %}" method="POST">
                            {% csrf_token %}
                            {{ form_avaliacao.as_p }}
                            <button class="btn btn-success w-100 mt-3 py-2 fw-bold text-uppercase shadow-sm"><i class="fas fa-save me-2"></i> Salvar Nota e Dar Pontos</button>
                        </form>
                    </div>
                    <div class="tab-pane fade" id="pills-prova" role="tabpanel">
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="fw-bold text-muted small text-uppercase">T√≠tulo da Prova</label>
                                <div class="input-group">
                                    <input type="text" id="printTitulo" class="form-control fw-bold" placeholder="Ex: Vari√°veis em Python, Verbo To Be...">
                                    <button class="btn btn-outline-primary fw-bold" type="button" onclick="gerarPerguntasAutomaticas()"><i class="fas fa-magic me-1"></i> Gerar Perguntas</button>
                                </div>
                            </div>
                            <div class="col-md-12 mb-3">
                                <label class="fw-bold text-muted small text-uppercase">Quest√µes (Edit√°vel)</label>
                                <textarea id="printQuestoes" class="form-control" rows="8" placeholder="Digite o tema acima e clique em 'Gerar Perguntas' ou escreva manualmente aqui..."></textarea>
                            </div>
                            <div class="col-md-12">
                                <button type="button" onclick="imprimirProva()" class="btn btn-dark w-100 py-3 fw-bold shadow hover-scale"><i class="fas fa-print me-2 text-warning"></i> GERAR FOLHA DE PROVA</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditarDisciplina" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold">Editar Curso</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="formEditarDisciplina" method="POST" action="">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="fw-bold">Nome do Curso</label>
                        <input type="text" name="novo_nome" id="editNomeCurso" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="fw-bold">Categoria</label>
                        <select name="nova_categoria" id="editCategoriaCurso" class="form-select">
                            <option value="EXTRA">üéì Curso Livre (Netflix)</option>
                            <option value="ESCOLA">üè´ Escola (SED)</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary fw-bold w-100">Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalExcluirDisciplina" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0">
            <div class="modal-header bg-danger text-white border-0">
                <h5 class="modal-title fw-bold">Tem certeza?</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center p-4">
                <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                <h5 class="fw-bold text-dark" id="delNomeCurso"></h5>
                <p class="text-muted">Isso ir√° apagar <strong>todo o hist√≥rico de aulas, notas e progresso</strong> deste curso permanentemente. N√£o h√° como desfazer.</p>
                
                <div class="d-flex gap-2 mt-4 justify-content-center">
                    <button type="button" class="btn btn-light border fw-bold px-4" data-bs-dismiss="modal">Cancelar</button>
                    <a href="#" id="btnConfirmarExclusao" class="btn btn-danger fw-bold px-4">Sim, Excluir Tudo</a>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    function switchMode(mode) {
        const btns = document.querySelectorAll('.mode-switch-btn');
        const viewEscola = document.getElementById('view-escola');
        const viewCursos = document.getElementById('view-cursos');
        const titulo = document.getElementById('page-title');

        btns.forEach(btn => {
            if (btn.dataset.mode === mode) {
                btn.classList.remove('btn-light', 'text-muted');
                btn.classList.add('btn-primary', 'shadow-sm');
            } else {
                btn.classList.remove('btn-primary', 'shadow-sm');
                btn.classList.add('btn-light', 'text-muted');
            }
        });

        if (mode === 'escola') {
            viewCursos.classList.add('d-none');
            viewEscola.classList.remove('d-none');
            titulo.innerHTML = '<i class="fas fa-graduation-cap me-2 text-primary"></i>Gest√£o Escolar';
        } else {
            viewEscola.classList.add('d-none');
            viewCursos.classList.remove('d-none');
            titulo.innerHTML = '<i class="fas fa-laptop-code me-2 text-success"></i>Cursos & Skills';
        }

        const filterItems = document.querySelectorAll('.filter-item');
        filterItems.forEach(item => {
            const isStudent = item.dataset.student === 'true'; 
            const isCourse = item.dataset.course === 'true'; 

            if (mode === 'escola') {
                if (isStudent) {
                    item.classList.remove('d-none-filter');
                    item.style.display = 'flex';
                } else {
                    item.classList.add('d-none-filter');
                    item.style.display = 'none';
                }
            } else {
                if (isCourse) {
                    item.classList.remove('d-none-filter');
                    item.style.display = 'flex';
                } else {
                    item.classList.add('d-none-filter');
                    item.style.display = 'none';
                }
            }
        });

        localStorage.setItem('painelEstudosMode', mode);
        setTimeout(() => {
            document.querySelectorAll('.dynamic-bar').forEach(bar => {
                bar.style.width = bar.getAttribute('aria-valuenow') + '%';
            });
        }, 50);
    }

    document.addEventListener("DOMContentLoaded", function() {
        const lastMode = localStorage.getItem('painelEstudosMode') || 'escola';
        switchMode(lastMode);

        const checkboxes = document.querySelectorAll('.filtro-checkbox');
        const contentArea = document.getElementById('conteudo-dinamico');
        const loadingOverlay = document.getElementById('loading-overlay');
        const contadorAlunos = document.getElementById('contador-alunos');

        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => atualizarPainel());
        });

        function atualizarPainel() {
            if(loadingOverlay) loadingOverlay.style.display = 'flex';
            const params = new URLSearchParams(window.location.search);
            params.delete('filhos');
            let count = 0;
            checkboxes.forEach(chk => { if(chk.checked) { params.append('filhos', chk.value); count++; } });
            
            const newUrl = `${window.location.pathname}?${params.toString()}`;
            window.history.pushState({path: newUrl}, '', newUrl);

            fetch(newUrl)
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    contentArea.innerHTML = doc.getElementById('conteudo-dinamico').innerHTML;
                    if(contadorAlunos) contadorAlunos.innerHTML = `<i class="fas fa-user-check me-1"></i> ${count} pessoa(s)`;
                    const currentMode = localStorage.getItem('painelEstudosMode') || 'escola';
                    switchMode(currentMode);
                    if(loadingOverlay) loadingOverlay.style.display = 'none';
                });
        }
        
        document.querySelectorAll('.dropdown-menu form').forEach(menu => {
            menu.addEventListener('click', (e) => e.stopPropagation());
        });
    });

    // --- L√ìGICA DO PLAYER COMPLET√ÉO ---
    
    function abrirModalPlayer(aulaId, alunoId) {
        if (!aulaId || aulaId === 'None') {
            alert("N√£o h√° aulas dispon√≠veis para assistir neste curso.");
            return;
        }
        
        const modal = new bootstrap.Modal(document.getElementById('modalPlayer'));
        modal.show();
        
        document.getElementById('playerAlunoId').value = alunoId;
        carregarDadosAula(aulaId);
    }

    function carregarDadosAula(aulaId) {
        const alunoId = document.getElementById('playerAlunoId').value;
        const vid = document.getElementById('videoTag');
        const frame = document.getElementById('videoFrame');
        
        // Pausa v√≠deo atual
        vid.pause(); 
        
        // Chama API com o aluno_id para marcar os 'vistos' corretamente
        fetch(`/estudos/api/player/${aulaId}/?aluno_id=${alunoId}`)
            .then(response => response.json())
            .then(data => {
                // 1. Atualiza Info B√°sica
                document.getElementById('playerTitulo').innerText = data.titulo;
                document.getElementById('playerModulo').innerText = data.modulo;
                
                // 2. Atualiza IDs de Navega√ß√£o
                document.getElementById('playerAulaId').value = data.id;
                document.getElementById('playerNextId').value = data.proxima_id || '';
                document.getElementById('playerPrevId').value = data.anterior_id || '';

                // 3. Atualiza Bot√µes
                document.getElementById('btnAnterior').disabled = !data.anterior_id;
                const btnNext = document.getElementById('btnProxima');
                if (!data.proxima_id) {
                    btnNext.innerHTML = '<i class="fas fa-check"></i> Finalizar';
                    btnNext.classList.remove('btn-success');
                    btnNext.classList.add('btn-primary');
                } else {
                    btnNext.innerHTML = 'Concluir e Pr√≥xima <i class="fas fa-step-forward ms-2"></i>';
                    btnNext.classList.add('btn-success');
                }

                // 4. Carrega o V√≠deo
                if (data.is_file) {
                    vid.src = data.video_url;
                    vid.style.display = 'block';
                    frame.style.display = 'none';
                    vid.load();
                    vid.play().catch(e => console.log("Autoplay bloqueado pelo browser"));
                } else {
                    frame.src = data.video_url;
                    frame.style.display = 'block';
                    vid.style.display = 'none';
                }

                // 5. INJETA A PLAYLIST (SIDEBAR)
                if (data.playlist_html) {
                    document.getElementById('playlistContainer').innerHTML = data.playlist_html;
                    
                    // Rola a barra lateral at√© a aula ativa
                    setTimeout(() => {
                        const activeItem = document.querySelector('.active-lesson');
                        if (activeItem) {
                            activeItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, 500);
                }
            })
            .catch(err => {
                console.error(err);
                alert("Erro ao carregar aula.");
            });
    }

    function navegarAula(direcao) {
        const alunoId = document.getElementById('playerAlunoId').value;
        const aulaId = document.getElementById('playerAulaId').value;
        let targetId = '';

        if (direcao === 'next') {
            targetId = document.getElementById('playerNextId').value;
            
            // Marca como conclu√≠do (AJAX POST)
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            fetch(`/estudos/api/player/${aulaId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken, 
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `aluno_id=${alunoId}`
            }).then(() => {
                // Se n√£o tiver pr√≥xima, avisa fim
                if (!targetId) {
                    alert("Parab√©ns! Curso Finalizado!");
                    location.reload();
                } else {
                    carregarDadosAula(targetId);
                }
            });
        } else {
            targetId = document.getElementById('playerPrevId').value;
            if (targetId) carregarDadosAula(targetId);
        }
    }

    function pararVideo() {
        const vid = document.getElementById('videoTag');
        vid.pause();
        vid.src = "";
        document.getElementById('videoFrame').src = "";
        // Recarrega a p√°gina ao fechar para atualizar a barra de progresso no dashboard
        location.reload();
    }

    // --- OUTRAS FUN√á√ïES ---

    function abrirModalCurso(alunoId) {
        const select = document.getElementById('selectAlunoDisciplina');
        if(select) select.value = alunoId;
        const modal = new bootstrap.Modal(document.getElementById('modalDisciplina'));
        modal.show();
    }

    function imprimirProva() {
        const titulo = document.getElementById('printTitulo').value || "Avalia√ß√£o de Conhecimentos";
        const questoesTexto = document.getElementById('printQuestoes').value;
        if (!questoesTexto) { alert("Digite pelo menos uma quest√£o para imprimir."); return; }
        const questoesArray = questoesTexto.split('\n');
        let htmlQuestoes = '';
        questoesArray.forEach((q, index) => {
            if(q.trim() !== "") {
                htmlQuestoes += `<div class="questao-block"><p class="questao-titulo"><strong>${index + 1}.</strong> ${q}</p><div class="linhas-resposta"></div><div class="linhas-resposta"></div><div class="linhas-resposta"></div></div>`;
            }
        });
        const janelaPrint = window.open('', '', 'height=800,width=800');
        janelaPrint.document.write(`<html><head><title>Prova - ${titulo}</title><style>body { font-family: 'Arial', sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; } .header { border-bottom: 2px solid #000; padding-bottom: 20px; margin-bottom: 30px; display: flex; align-items: center; justify-content: space-between; } .info-aluno { margin-bottom: 30px; font-size: 14px; border: 1px solid #ccc; padding: 15px; border-radius: 8px; } .nota-box { float: right; border: 2px solid #000; width: 80px; height: 80px; text-align: center; line-height: 80px; font-size: 20px; font-weight: bold; border-radius: 8px; margin-top: -50px; } .questao-block { margin-bottom: 25px; page-break-inside: avoid; } .questao-titulo { font-size: 16px; margin-bottom: 10px; } .linhas-resposta { border-bottom: 1px solid #e0e0e0; height: 30px; width: 100%; margin-bottom: 5px; }</style></head><body><div class="header"><div><h1>${titulo}</h1><p>Fam√≠lia Bonani - Centro de Estudos</p></div><div class="nota-box">NOTA</div></div><div class="info-aluno"><p><strong>Aluno(a):</strong> _______________________________________________________</p><p style="margin-top: 15px;"><strong>Data:</strong> ____/____/_______ &nbsp;&nbsp;&nbsp; <strong>M√≥dulo:</strong> ________________________</p></div><div class="corpo-prova">${htmlQuestoes}</div></body></html>`);
        janelaPrint.document.close();
        janelaPrint.print();
    }

    function gerarPerguntasAutomaticas() {
        const tituloInput = document.getElementById('printTitulo');
        const textarea = document.getElementById('printQuestoes');
        const titulo = tituloInput.value;
        if (!titulo) { alert("Por favor, digite um t√≠tulo (ex: 'Vari√°veis', 'Loop') para eu saber sobre o que √© a prova!"); tituloInput.focus(); return; }
        textarea.value = "Consultando banco de dados pedag√≥gico...";
        textarea.disabled = true;
        fetch(`{% url 'estudos:api_gerar_questoes' %}?titulo=${encodeURIComponent(titulo)}`)
            .then(response => response.json())
            .then(data => { textarea.value = data.questoes; textarea.disabled = false; })
            .catch(error => { console.error('Erro:', error); textarea.value = "Erro ao gerar quest√µes. Tente manualmente."; textarea.disabled = false; });
    }

    function prepararAvaliacao(nomeCurso) { console.log("Lan√ßando nota para: " + nomeCurso); }

    function abrirModalEditar(id, nome, categoria) {
        document.getElementById('editNomeCurso').value = nome;
        document.getElementById('editCategoriaCurso').value = categoria;
        const form = document.getElementById('formEditarDisciplina');
        form.action = `/estudos/editar/disciplina/${id}/`; // Ajusta a URL do form
        const modal = new bootstrap.Modal(document.getElementById('modalEditarDisciplina'));
        modal.show();
    }

    function abrirModalExcluir(id, nome) {
        document.getElementById('delNomeCurso').textContent = nome;
        const btn = document.getElementById('btnConfirmarExclusao');
        btn.href = `/estudos/excluir/disciplina/${id}/`; // Ajusta o link de exclus√£o
        const modal = new bootstrap.Modal(document.getElementById('modalExcluirDisciplina'));
        modal.show();
    }
</script>
{% endblock %}