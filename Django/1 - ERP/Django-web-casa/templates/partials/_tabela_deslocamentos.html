{% load static %}

<div class="table-responsive" style="overflow-x: hidden;">
    <table id="tabela-deslocamentos" class="table table-striped table-hover align-middle table-fixed mb-0" style="width:100%">
        <thead class="table-light small text-uppercase">
            <tr>
                <th class="col-id text-center" style="width: 40px;">#</th>
                <th class="col-data" style="width: 90px;">Data</th>
                <th class="d-none d-md-table-cell col-data" style="width: 110px;">Veículo</th>
                <th class="d-none d-lg-table-cell col-data" style="width: 100px;">Resp.</th>
                <th class="col-rota" style="width: auto;">Rota Realizada</th>
                <th class="col-km text-end" style="width: 70px;">Dist.</th>
                <th class="col-tempo text-end d-none d-sm-table-cell" style="width: 70px;">Tempo</th>
                <th class="col-custo text-end" style="width: 90px;">Custo</th>
                <th class="text-center" style="width: 90px;">Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for dia in dias_deslocamento %}
            <tr>
                <td class="text-center text-muted small">{{ dia.pk }}</td>
                <td class="fw-bold text-primary small">{{ dia.data|date:"d/m/y" }}</td>
                
                <td class="d-none d-md-table-cell text-nowrap small">
                    {% if dia.veiculo %}
                        <span class="fw-bold">{{ dia.veiculo.modelo }}</span><br>
                        <span class="text-muted" style="font-size: 0.75rem;">{{ dia.veiculo.placa }}</span>
                    {% else %}
                        <span class="badge bg-secondary">--</span>
                    {% endif %}
                </td>

                <td class="d-none d-lg-table-cell text-nowrap small">
                    {{ dia.usuario.username|title }}
                </td>

                <td class="p-1 overflow-hidden">
                    <a href="javascript:void(0);" class="text-decoration-none text-dark btn-ver-rota d-block p-2 rounded hover-bg-light" data-id="{{ dia.pk }}" title="Clique para ver detalhes">
                        {% if dia.percursos.exists %}
                            <div class="d-flex flex-column" style="font-size: 0.85rem; line-height: 1.2;">
                                <div class="d-flex align-items-center text-truncate-fix mb-1">
                                    <span class="badge bg-success me-2" style="font-size: 0.6rem; width: 20px;">A</span>
                                    <span class="small text-dark">{{ dia.origem_display }}</span>
                                </div>
                                <div class="ps-2 ms-1 border-start border-2 dotted" style="height: 12px; margin-top: -2px; margin-bottom: -2px;">
                                    {% if dia.percursos.count > 1 %}
                                        <small class="text-muted ms-2 fst-italic" style="font-size: 0.7rem; position: relative; top: -3px;">
                                            + {{ dia.percursos.count|add:"-1" }} paradas
                                        </small>
                                    {% endif %}
                                </div>
                                <div class="d-flex align-items-center text-truncate-fix mt-1">
                                    <span class="badge bg-danger me-2" style="font-size: 0.6rem; width: 20px;">B</span>
                                    <span class="small fw-bold text-dark">{{ dia.destino_display }}</span>
                                </div>
                            </div>
                        {% else %}
                            <span class="text-muted small">Sem dados de rota</span>
                        {% endif %}
                    </a>
                </td>

                <td class="text-end fw-bold small">{{ dia.km_total_apurado|floatformat:1 }}</td>
                <td class="text-end text-muted d-none d-sm-table-cell small">{{ dia.tempo_total_min }}'</td>
                
                <td class="text-end text-success fw-bold small">R$ {{ dia.custo_total_estimado|floatformat:2 }}</td>

                <td class="text-center">
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-info btn-detalhes p-0 px-2 border-0" data-id="{{ dia.pk }}" title="Ver Detalhes"><i class="fas fa-map-marked-alt"></i></button>
                        <button class="btn btn-outline-warning btn-editar p-0 px-2 border-0" data-id="{{ dia.pk }}" title="Editar"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-outline-danger btn-excluir p-0 px-2 border-0" data-id="{{ dia.pk }}" title="Excluir"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot class="table-secondary fw-bold small border-top-2">
            <tr>
                <td colspan="5" class="text-end text-uppercase pe-3">Totais:</td>
                <td class="text-end text-primary" id="total-km">0,0</td>
                <td class="text-end d-none d-sm-table-cell" id="total-tempo">0'</td>
                <td class="text-end text-success" id="total-custo" style="font-size: 0.95rem;">R$ 0,00</td>
                <td></td>
            </tr>
        </tfoot>
    </table>
    <style>
        .hover-bg-light:hover { background-color: #f8f9fa; cursor: pointer; }
        .text-truncate-fix { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        .dotted { border-left-style: dotted !important; border-color: #ccc !important; }
        tfoot td { vertical-align: middle !important; background-color: #e2e3e5 !important; }
    </style>
</div>