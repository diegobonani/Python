{% load humanize %}

<div class="table-responsive">
    <table id="tabela-principal" class="table table-hover align-middle w-100 table-sm text-nowrap">
        <thead class="table-light">
            <tr>
                <th style="width: 15%;">Imóvel</th>          <th style="width: 20%;">Item</th>            <th style="width: 15%;">Cômodo / Dono</th>   <th style="width: 15%;">Localização</th>     <th style="width: 10%;">Qtd.</th>            <th style="width: 10%;">Validade</th>        <th class="text-end" style="width: 15%;">Ações</th> </tr>
        </thead>
        <tbody>
            {% for hub in itens_estoque %}
                {% with item=hub.get_detalhe %}
                {% if item %}
                    <tr class="{% if item.quantidade <= 0 %}tr-status-critico{% elif item.quantidade <= item.estoque_minimo %}tr-status-baixo{% elif item.quantidade >= item.estoque_ideal %}tr-status-cheio{% else %}tr-status-ok{% endif %}">
                        
                        <td class="fw-bold text-primary">
                            {% if hub.setor == 'CASA' %}
                                <i class="fas fa-building me-1"></i> {{ item.comodo.imovel.nome|default:"Sem Cadastro" }}
                            {% else %}
                                <span class="text-muted text-center d-block">-</span>
                            {% endif %}
                        </td>

                        <td>
                            <div class="fw-bold text-dark">{{ item.nome }}</div>
                            <small class="text-muted" style="font-size: 0.75rem;">{{ item.categoria.nome_categoria|default:"Geral" }}</small>
                        </td>

                        <td>
                            {% if hub.setor == 'CASA' %}
                                {{ item.comodo.nome|default:"-" }}
                            {% elif hub.setor == 'PET' %}
                                <span class="badge bg-warning text-dark"><i class="fas fa-paw"></i> {{ item.pet.nome_pet }}</span>
                            {% elif hub.setor == 'USUARIO' %}
                                <span class="badge bg-info text-white"><i class="fas fa-user"></i> {{ item.usuario.username }}</span>
                            {% endif %}
                        </td>

                        <td>
                            {% if hub.setor == 'CASA' %}
                                {% if item.localizacao %}
                                    <i class="fas fa-map-marker-alt text-secondary me-1" style="font-size: 0.7rem;"></i> {{ item.localizacao.nome }}
                                {% else %}
                                    <span class="text-muted small">-</span>
                                {% endif %}
                            {% else %}
                                <span class="text-muted text-center d-block">-</span>
                            {% endif %}
                        </td>

                        <td>
                            <span class="fw-bold">{{ item.quantidade|floatformat:2 }}</span>
                            <small class="text-muted">{{ item.unidade.sigla|default:"UN" }}</small>
                            
                            {% if item.quantidade <= 0 %}
                                <i class="fas fa-circle text-danger ms-1" style="font-size: 0.5rem;" title="Zerado"></i>
                            {% elif item.quantidade <= item.estoque_minimo %}
                                <i class="fas fa-circle text-warning ms-1" style="font-size: 0.5rem;" title="Baixo"></i>
                            {% endif %}
                        </td>

                        <td>
                            {% if item.validade %}
                                {% if item.validade < today %}
                                    <span class="badge bg-danger">Vencido</span>
                                    <div class="small text-danger fw-bold">{{ item.validade|date:"d/m/y" }}</div>
                                {% elif item.validade < today|date:"Y-m-d"|add:"30" %}
                                    <span class="badge bg-warning text-dark">Atenção</span>
                                    <div class="small text-dark">{{ item.validade|date:"d/m/y" }}</div>
                                {% else %}
                                    <div class="text-success">{{ item.validade|date:"d/m/y" }}</div>
                                {% endif %}
                            {% else %}
                                <span class="text-muted small">-</span>
                            {% endif %}
                        </td>

                        <td class="text-end">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-warning btn-dar-baixa" 
                                        data-id="{{ hub.id }}" 
                                        data-unidade="{{ item.unidade.sigla|default:'UN' }}"
                                        title="Baixa">
                                    <i class="fas fa-minus"></i>
                                </button>
                                
                                <button class="btn btn-outline-primary 
                                    {% if hub.setor == 'CASA' %}btn-editar-item-casa
                                    {% elif hub.setor == 'PET' %}btn-editar-item-pet
                                    {% else %}btn-editar-item-usuario{% endif %}" 
                                    data-id="{{ hub.id }}" 
                                    title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>

                                <button class="btn btn-outline-danger btn-excluir-item" data-id="{{ hub.id }}" title="Excluir">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                {% endif %}
                {% endwith %}
            {% empty %}
                <tr>
                    <td colspan="7" class="text-center py-5 text-muted">
                        <i class="fas fa-search fa-2x mb-2 opacity-50"></i>
                        <p class="mb-0">Nenhum item encontrado neste período/filtro.</p>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>