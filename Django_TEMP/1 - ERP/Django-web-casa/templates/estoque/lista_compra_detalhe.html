{% extends 'base_dashboard.html' %}
{% load i18n %}

{% block title %}Detalhes da Compra - {{ compra.supermercado }}{% endblock %}

{% block sidebar %}
  {% include 'partials/sidebar_admin.html' %}
{% endblock %}

{% block main_content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">Detalhes da Compra</h1>
    <a href="{% url 'gerenciar_estoque' %}" class="btn btn-secondary"><i class="fas fa-arrow-left me-2"></i>Voltar para Gerenciar Estoque</a>
  </div>

  <div class="card mb-4">
    <div class="card-body">
      <h5><strong>Estabelecimento:</strong> {{ compra.supermercado }}</h5>
      <p class="mb-1"><strong>Cidade:</strong> {{ compra.cidade }}</p>
      <p class="mb-2"><strong>Data:</strong> {{ compra.data_compra|date:"d/m/Y" }}</p>
      <h4 class="text-success"><strong>Valor Total: R$ <span id="valor-total-compra">{{ compra.valor_total|floatformat:"2g" }}</span></strong></h4>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-4 mb-4">
      <div class="card">
        <div class="card-header"><h5><i class="fas fa-plus-circle me-2"></i>Adicionar Produto</h5></div>
        <div class="card-body">
          <form method="post" action="{% url 'lista_compra_detalhe' pk=compra.pk %}">
            {% csrf_token %}
            
            {{ form_produto.nome.label_tag }}
            {{ form_produto.nome }}
            {{ form_produto.marca.label_tag }}
            {{ form_produto.marca }}
            {{ form_produto.quantidade.label_tag }}
            {{ form_produto.quantidade }}
            {{ form_produto.unidade.label_tag }}
            {{ form_produto.unidade }}
            {{ form_produto.valor_unit.label_tag }}
            {{ form_produto.valor_unit }}

            <hr>
            
            <div class="form-check form-switch mb-3">
              {{ form_produto.adicionar_ao_estoque }}
              <label class="form-check-label" for="{{ form_produto.adicionar_ao_estoque.id_for_label }}">Adicionar diretamente ao Estoque da Casa?</label>
            </div>

            <div id="campos-estoque-casa" style="display: none;">
                <div class="mb-2">{{ form_produto.categoria.label_tag }}{{ form_produto.categoria }}{% if form_produto.categoria.errors %}<div class="invalid-feedback d-block">{{ form_produto.categoria.errors }}</div>{% endif %}</div>
                <div class="mb-2">{{ form_produto.comodo.label_tag }}{{ form_produto.comodo }}{% if form_produto.comodo.errors %}<div class="invalid-feedback d-block">{{ form_produto.comodo.errors }}</div>{% endif %}</div>
                <div class="mb-2">{{ form_produto.data_validade.label_tag }}{{ form_produto.data_validade }}</div>
            </div>

            <div class="mt-3 bg-light p-2 rounded text-center">
                <strong>Subtotal Calculado: <span id="subtotal-calculado" class="text-success">R$ 0,00</span></strong>
            </div>

            <button type="submit" class="btn btn-primary w-100 mt-3">Adicionar Produto</button>
          </form>
        </div>
      </div>
    </div>
    
    <div class="col-lg-8 mb-4">
      <div class="card">
        <div class="card-header"><h5><i class="fas fa-list-ul me-2"></i>Produtos da Compra</h5></div>
        <div class="card-body">
          <table id="tabela-produtos" class="table table-striped table-bordered" style="width:100%">
            <thead><tr><th>Produto</th><th>Qtd.</th><th>Valor Unit.</th><th class="text-end">Subtotal</th><th class="text-end">Ações</th></tr></thead>
            <tbody>
              {% for produto in produtos %}
              <tr data-id="{{ produto.pk }}">
                <td>{{ produto.nome }} <small class="text-muted">({{ produto.marca|default:"" }})</small></td>
                <td>{{ produto.quantidade|floatformat:"-3g" }} {% if produto.unidade %}{{ produto.unidade.codigo }}{% endif %}</td>
                <td>R$ {{ produto.valor_unit|floatformat:"2g" }}</td>
                <td class="text-end">R$ {{ produto.subtotal|floatformat:"2g" }}</td>
                <td class="text-end">
                    <button class="btn btn-primary btn-sm btn-editar-produto" data-id="{{ produto.pk }}" title="Editar"><i class="fas fa-edit"></i></button>
                    
                    {% if not produto.adicionado_ao_estoque %}
                      <button class="btn btn-success btn-sm btn-add-to-stock" data-produto-id="{{ produto.pk }}" title="Mover para o Estoque Geral"><i class="fas fa-plus"></i></button>
                    {% else %}
                      <button class="btn btn-danger btn-sm btn-reverter-estoque" data-produto-id="{{ produto.pk }}" title="Desfazer entrada no estoque"><i class="fas fa-minus"></i></button>
                    {% endif %}

                    <button class="btn btn-danger btn-sm btn-excluir-produto" data-id="{{ produto.pk }}" title="Excluir"><i class="fas fa-trash"></i></button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalEditarProduto" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><form id="formEditarProduto">{% csrf_token %}<div class="modal-header"><h5 class="modal-title">Editar Produto</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">{{ form_produto.as_p }}</div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary">Salvar Alterações</button></div></form></div></div></div>
  <div class="modal fade" id="modalConfirmarExclusaoProduto" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="modalConfirmarExclusaoProdutoLabel">Confirmar Ação</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p id="textoConfirmacao"></p></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><form id="formConfirmacao" method="post">{% csrf_token %}<button type="submit" class="btn btn-danger">Confirmar</button></form></div></div></div></div>
  <div class="modal fade" id="modalMoverParaEstoque" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><form id="formMoverParaEstoque">{% csrf_token %}<div class="modal-header"><h5 class="modal-title">Mover Item para o Estoque Geral</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Para onde você quer adicionar o item: <strong id="nomeItemParaMover"></strong>?</p><div class="mb-3"><label for="id_setor_destino" class="form-label">Setor de Destino</label><select id="id_setor_destino" name="setor" class="form-select"><option value="USUARIO" selected>Usuário</option><option value="PET">Pet</option><option value="CASA">Casa</option></select></div><div id="campos-destino"></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary">Confirmar e Mover</button></div></form></div></div></div>
{% endblock %}


{% block scripts %}
<script>
$(document).ready(function() {
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // --- INICIALIZAÇÃO ---
    $('#tabela-produtos').DataTable({ language: { url: 'https://cdn.datatables.net/plug-ins/2.0.8/i18n/pt-BR.json' }, "order": [] });
    var modalEditar = new bootstrap.Modal(document.getElementById('modalEditarProduto'));
    var modalConfirmar = new bootstrap.Modal(document.getElementById('modalConfirmarExclusaoProduto'));
    var modalMover = new bootstrap.Modal(document.getElementById('modalMoverParaEstoque'));

    // --- LÓGICA DO FORMULÁRIO DINÂMICO DE ADIÇÃO ---
    const campoUnidadeAdd = $('#id_unidade');
    const campoQuantidadeAdd = $('#id_quantidade');
    const labelQuantidadeAdd = $('label[for="id_quantidade"]');
    const labelPrecoAdd = $('label[for="id_valor_unit"]');
    const displaySubtotal = $('#subtotal-calculado');
    const checkAddToStock = $('#id_adicionar_ao_estoque');
    const camposEstoque = $('#campos-estoque-casa');

    function atualizarFormulario() {
        const unidadeSelecionadaTexto = campoUnidadeAdd.find('option:selected').text().toLowerCase();
        const isPorPeso = unidadeSelecionadaTexto.includes('kg') || unidadeSelecionadaTexto.includes('grama');
        const isPorVolume = unidadeSelecionadaTexto.includes('litro') || unidadeSelecionadaTexto.includes('ml');
        if (unidadeSelecionadaTexto === 'unidade') {
            labelQuantidadeAdd.text('Quantidade');
            campoQuantidadeAdd.attr('step', '1').attr('placeholder', 'Ex: 1, 2, 3...');
            labelPrecoAdd.text('Preço por Unidade');
            const valorAtual = parseFloat(campoQuantidadeAdd.val());
            if (!isNaN(valorAtual)) { campoQuantidadeAdd.val(Math.trunc(valorAtual)); }
        } else {
            campoQuantidadeAdd.attr('step', '0.001');
            if (isPorPeso) {
                labelQuantidadeAdd.text('Peso Total (em KG)');
                campoQuantidadeAdd.attr('placeholder', 'Ex: 0.500 para 500g');
                labelPrecoAdd.text('Preço por KG');
            } else if (isPorVolume) {
                labelQuantidadeAdd.text('Volume Total (em L)');
                campoQuantidadeAdd.attr('placeholder', 'Ex: 1.500 para 1.5L');
                labelPrecoAdd.text('Preço por Litro');
            }
        }
    }
    
    function calcularSubtotal() {
        const quantidade = parseFloat($('#id_quantidade').val()) || 0;
        const preco = parseFloat($('#id_valor_unit').val()) || 0;
        const subtotal = quantidade * preco;
        displaySubtotal.text('R$ ' + subtotal.toFixed(2).replace('.', ','));
    }

    function toggleEstoqueFields() {
        camposEstoque.toggle(checkAddToStock.is(':checked'));
    }

    campoUnidadeAdd.on('change', function() { atualizarFormulario(); calcularSubtotal(); });
    $('#id_quantidade, #id_valor_unit').on('input', calcularSubtotal);
    checkAddToStock.on('change', toggleEstoqueFields);
    atualizarFormulario();
    toggleEstoqueFields();

    // --- LÓGICA DE EDIÇÃO ---
    $('#tabela-produtos tbody').on('click', '.btn-editar-produto', function() {
        var produtoId = $(this).data('id');
        var form = $('#formEditarProduto');
        form.attr('action', `/estoque/produto/editar/${produtoId}/`);
        $.ajax({
            url: `/estoque/produto/json/${produtoId}/`,
            success: function(data) {
                form.find('#id_nome').val(data.nome);
                form.find('#id_marca').val(data.marca);
                form.find('#id_quantidade').val(data.quantidade);
                form.find('#id_unidade').val(data.unidade_id);
                form.find('#id_valor_unit').val(data.valor_unit);
                // Esconde os campos extras no modo de edição
                form.find('#id_adicionar_ao_estoque').closest('div').hide();
                form.find('#campos-estoque-casa').hide();
                modalEditar.show();
            }
        });
    });

    $('#formEditarProduto').on('submit', function(e) {
        e.preventDefault();
        $.ajax({ type: 'POST', url: $(this).attr('action'), data: $(this).serialize(),
            success: function(response) {
                if (response.success) { location.reload(); } else { alert('Erro ao salvar.'); }
            }
        });
    });

    // --- LÓGICA PARA MOVER PARA O ESTOQUE ---
    $('#tabela-produtos tbody').on('click', '.btn-add-to-stock', function() {
        var produtoId = $(this).data('produto-id');
        var produtoNome = $(this).closest('tr').find('td:first').text().trim();
        $('#formMoverParaEstoque').attr('action', `/estoque/produto/mover-para-estoque/${produtoId}/`);
        $('#nomeItemParaMover').text(produtoNome);
        // Lógica para preencher dinamicamente os campos de destino pode ser adicionada aqui
        modalMover.show();
    });

    $('#formMoverParaEstoque').on('submit', function(e) {
        e.preventDefault();
        $.ajax({
            type: 'POST', url: $(this).attr('action'), data: $(this).serialize(),
            success: function(response) {
                if (response.success) { location.reload(); } else { alert('Erro: ' + response.message); }
            },
            error: function(xhr) { alert('Erro: ' + (xhr.responseJSON ? xhr.responseJSON.message : 'Verifique os campos')); }
        });
    });

    // --- LÓGICA DE EXCLUSÃO E REVERSÃO (usando o mesmo modal) ---
    $('#tabela-produtos tbody').on('click', '.btn-excluir-produto, .btn-reverter-estoque', function() {
        var button = $(this);
        var produtoId = button.data('id') || button.data('produto-id');
        var isRevert = button.hasClass('btn-reverter-estoque');
        
        $('#modalConfirmarExclusaoProdutoLabel').text(isRevert ? 'Confirmar Reversão' : 'Confirmar Exclusão');
        $('#textoConfirmacao').text(isRevert ? 'Deseja devolver este item do Estoque Geral? A quantidade será subtraída do seu inventário.' : 'Deseja mesmo excluir este produto? A ação não pode ser desfeita.');
        $('#formConfirmacao').attr('action', isRevert ? `/estoque/produto/reverter-estoque/${produtoId}/` : `/estoque/produto/deletar/${produtoId}/`);
        
        modalConfirmar.show();
    });

    $('#formConfirmacao').on('submit', function(e) {
        e.preventDefault();
        $.ajax({
            type: 'POST', url: $(this).attr('action'), data: $(this).serialize(),
            success: function(response) {
                if (response.success) { location.reload(); } else { alert('Erro: ' + response.message); }
            },
            error: function(xhr) { alert('Erro: ' + (xhr.responseJSON ? xhr.responseJSON.message : 'Ocorreu um erro')); }
        });
    });
});
</script>
{% endblock %}